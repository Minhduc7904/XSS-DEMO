<!doctype html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>üí¨ Ph√≤ng chat chung</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f7fb;
        }

        #chat {
            border: 1px solid #ccc;
            border-radius: 6px;
            background: #fff;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
        }

        .msg {
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px dashed #eee;
        }

        .meta {
            font-size: 12px;
            color: #666;
            margin-bottom: 3px;
        }

        textarea {
            width: 100%;
            height: 60px;
            margin-top: 8px;
            padding: 6px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        button {
            margin-top: 6px;
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            background: #2563eb;
            color: #fff;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <h2>üí¨ Ph√≤ng chat chung</h2>
    <div>
        <label>T√™n: <input id="user" value="A" style="width:80px"></label>
    </div>

    <div id="chat"></div>

    <textarea id="input" placeholder="Nh·∫≠p tin nh·∫Øn..."></textarea><br />
    <button id="send">G·ª≠i</button>

    <!-- <button id="checkCookies">Ki·ªÉm tra cookie</button>
    <pre id="cookieOutput"
        style="background:#fff;padding:8px;border:1px solid #ddd;border-radius:6px;white-space:pre-wrap;"></pre> -->


    <script>
        document.cookie = "hello; max-age=86400; path=/; SameSite=Strict";

        // document.getElementById('checkCookies').addEventListener('click', () => {
        //     // L·∫•y cookie (ch·ªâ nh·ªØng cookie client c√≥ th·ªÉ ƒë·ªçc ƒë∆∞·ª£c)
        //     const cookies = document.cookie || '(Kh√¥ng c√≥ cookie c√≥ th·ªÉ ƒë·ªçc b·∫±ng JS)';
        //     // Hi·ªÉn th·ªã an to√†n (text, kh√¥ng render HTML)
        //     document.getElementById('cookieOutput').textContent = cookies;
        // });
        function escapeHtml(s) {
            return String(s)
        }

        // function escapeHtml(str) {
        //     return String(str)
        //         .replace(/&/g, "&amp;")
        //         .replace(/</g, "&lt;")
        //         .replace(/>/g, "&gt;")
        //         .replace(/"/g, "&quot;")
        //         .replace(/'/g, "&#39;");
        // }
        const ws = new WebSocket("ws://localhost:8080");
        const userEl = document.getElementById("user");
        const inputEl = document.getElementById("input");
        const chatEl = document.getElementById("chat");

        ws.onopen = () => console.log("‚úÖ K·∫øt n·ªëi WS th√†nh c√¥ng");

        ws.onmessage = ev => {
            const data = JSON.parse(ev.data);
            if (data.system) {
                console.log("Server:", data.text);
                return;
            }
            renderMessage(data);
        };

        document.getElementById("send").onclick = () => {
            const msg = { user: userEl.value, text: inputEl.value };
            ws.send(JSON.stringify(msg));
            inputEl.value = "";
        };

        function renderMessage({ user, text, ts }) {
            const time = new Date(ts || Date.now()).toLocaleTimeString();
            const div = document.createElement("div");
            div.className = "msg";
            div.innerHTML = `<div class=\"meta\">${escapeHtml(user)} ‚Äî ${time}</div>\n                       <div>${text}</div>`;
            chatEl.appendChild(div);
            chatEl.scrollTop = chatEl.scrollHeight;

            // const scripts = div.querySelectorAll('script');
            // scripts.forEach(oldScript => {
            //     const newScript = document.createElement('script');
            //     // Copy thu·ªôc t√≠nh
            //     for (const attr of oldScript.attributes) {
            //         newScript.setAttribute(attr.name, attr.value);
            //     }
            //     newScript.textContent = oldScript.textContent;
            //     oldScript.parentNode.replaceChild(newScript, oldScript);
            // });
        }
        // function renderMessage({ user, text, ts }) {
        //     const time = new Date(ts || Date.now()).toLocaleTimeString();
        //     const div = document.createElement("div");
        //     div.className = "msg";

        //     const meta = document.createElement("div");
        //     meta.className = "meta";
        //     meta.textContent = `${user} ‚Äî ${time}`;

        //     const body = document.createElement("div");
        //     body.textContent = text; // <- kh√¥ng ph·∫£i innerHTML

        //     div.appendChild(meta);
        //     div.appendChild(body);

        //     chatEl.appendChild(div);
        //     chatEl.scrollTop = chatEl.scrollHeight;
        // }
    </script>
   


</body>

</html>